import{u as e,d as t,c as r,r as i,j as s,E as a,B as n,n as o,l,t as d,m as c,s as m,A as u,S as x}from"./index-8fe229f6.js";import{A as h}from"./AdminLayout-f0953381.js";const g=()=>Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15),p=()=>{const p=e(),{startLoading:b,stopLoading:f}=t(),{showError:y}=r(),[j,v]=i.useState(""),[_,$]=i.useState(""),[N,w]=i.useState(30),[I,q]=i.useState(0),[A,k]=i.useState(100),[C,E]=i.useState(!1),[S,O]=i.useState(null),[F,T]=i.useState("medium"),[P,M]=i.useState([]),[D,L]=i.useState([Y()]),[R,z]=i.useState(!1),[B,Q]=i.useState({});function U(){const e=localStorage.getItem(x.ADMIN_DATA);let t="";if(e)try{t=JSON.parse(e).token||""}catch(r){}return t?`Bearer ${t}`:""}function Y(){return{id:g(),title:"",type:"multiple-choice",options:[{id:g(),text:"الخيار 1"},{id:g(),text:"الخيار 2"}],correctOptionId:null}}i.useEffect((()=>{(async()=>{try{const e=await m.get(`${u.BASE_URL}/api/admin/sections`,{headers:{Authorization:U(),"Content-Type":"application/json"}});if(!e||!e.data)return void y("Failed to load sections. You can still create an exam, but section selection will be unavailable.");const t=e.data;t.sections&&Array.isArray(t.sections)?M(t.sections):t.success&&t.data&&t.data.sections?M(t.data.sections):Array.isArray(t)?M(t):y("Unable to parse sections data. Section selection may be unavailable.")}catch(e){y("Error loading sections. You can still create an exam, but section selection will be unavailable.")}})()}),[]);const W=(e,t,r,i)=>{L(D.map((s=>{var a;return s.id===e?{...s,matchingItems:(null==(a=s.matchingItems)?void 0:a.map((e=>e.id===t?{...e,[r]:i}:e)))||[]}:s})))};return s.jsxs(h,{children:[s.jsxs("div",{className:"mb-6",children:[s.jsx("h1",{className:"text-2xl font-bold text-white",children:"Create New Exam"}),s.jsx("p",{className:"text-gray-400 mt-1",children:"Create a new exam with questions and answers"})]}),s.jsxs("form",{onSubmit:async e=>{var t,r;if(e.preventDefault(),Q((e=>{if(!e.questions_summary)return e;const t={...e};return delete t.questions_summary,t})),!(()=>{const e={};j.trim()||(e.title="Title is required");const t=_.trim();t?t.length<10&&(e.description="Description must be at least 10 characters"):e.description="Description is required",N<=0&&(e.duration="Duration must be greater than 0"),F||(e.difficulty="Please select a difficulty level"),C||(I<0&&(e.minAge="Minimum age cannot be negative"),A<=I&&(e.maxAge="Maximum age must be greater than minimum age"));let r=!1;return D.forEach(((t,i)=>{var s;const a=`question_${i}`;t.title.trim()?t.title.trim().length<3&&(e[`${a}_title`]="Question title must be at least 3 characters long",r=!0):(e[`${a}_title`]="Question title is required",r=!0),"multiple-choice"===t.type||"true-false"===t.type?(t.options.length<2&&(e[`${a}_options`]="At least 2 options required"),t.options.forEach(((t,r)=>{t.text.trim()||(e[`${a}_option_${r}`]="Option text required")})),t.correctOptionId||(e[`${a}_correct`]="Correct answer selection required")):"short-answer"===t.type?(null==(s=t.correctAnswerText)?void 0:s.trim())||(e[`${a}_correct_text`]="Correct answer text required"):"matching"===t.type&&t.matchingItems?(t.matchingItems.length<2&&(e[`${a}_matching`]="At least 2 matching pairs required",r=!0),t.matchingItems.forEach(((t,i)=>{t.left.trim()||(e[`${a}_matching_${i}_left`]="Left side text required",r=!0),t.right.trim()||(e[`${a}_matching_${i}_right`]="Right side text required",r=!0)}))):"ordering"===t.type&&t.orderingItems&&(t.orderingItems.length<2&&(e[`${a}_ordering`]="At least 2 items required for ordering",r=!0),t.orderingItems.forEach(((t,i)=>{t.text.trim()||(e[`${a}_ordering_${i}`]="Item text required",r=!0)})))})),r&&(e.questions_summary="Please review and correct the errors in the questions below."),Q(e),0===Object.keys(e).length})())return void y("Please fix the validation errors in the form");const i={title:j,description:_,duration:N,isPublic:C,minAge:C?0:I,maxAge:C?100:A,sectionId:S,difficulty:F,questions:D.map((e=>{const t=e.id;let r=[],i=null;if("multiple-choice"===e.type||"true-false"===e.type){const t=e.options.find((t=>t.id===e.correctOptionId));if(!t)throw new Error(`Question "${e.title}" has no correct option selected`);i=t.id,r=e.options.map((e=>({id:e.id,text:e.text})))}else if("short-answer"===e.type){i=`${t}_correct`,r=[{id:i,text:e.correctAnswerText||""},{id:`${t}_incorrect`,text:"Incorrect"}]}else if("matching"===e.type&&e.matchingItems){if(r=e.matchingItems.map((e=>({id:e.id,text:`${e.left} -> ${e.right}`}))),0===r.length)throw new Error(`Matching question "${e.title}" has no options`);i=r[0].id}else if("ordering"===e.type&&e.orderingItems){if(r=[...e.orderingItems].sort(((e,t)=>e.correctPosition-t.correctPosition)).map((e=>({id:e.id,text:e.text}))),0===r.length)throw new Error(`Ordering question "${e.title}" has no options`);i=r[0].id}else r=[{id:`${t}_opt1`,text:"Option 1"},{id:`${t}_opt2`,text:"Option 2"}],i=r[0].id;return{text:e.title,options:r,correctOption:i}}))};z(!0);const s="create-exam";b(s,"Creating exam...");try{const e=await m.post(`${u.BASE_URL}/api/admin/exams`,i,{headers:{"Content-Type":"application/json",Authorization:U()}});if(!e||200!==e.status&&201!==e.status)throw new Error((null==(t=null==e?void 0:e.data)?void 0:t.message)||"Failed to create exam");const s=e.data;p("/admin/exams",{state:{message:"Exam created successfully!",examId:(null==(r=s.exam)?void 0:r.id)||s.id}})}catch(a){let e="Failed to create exam. Please try again.",t={};if(a.response&&a.response.data)if(a.response.data.fieldErrors){t=a.response.data.fieldErrors;const r={...B};Object.entries(t).forEach((([e,t])=>{var i;if(e.startsWith("questions.")||e.startsWith("questions[")){const s=e.match(/questions[.\[](\d+)/);if(s&&s[1]){const a=parseInt(s[1],10),n=null==(i=D[a])?void 0:i.id;n&&(e.includes("options")||e.includes("correctOptionIndex")?r[`question_${n}_options`]=String(t):r[`question_${n}`]=String(t))}}else r[e]=String(t)})),Q(r),e="Please correct the validation errors in the form."}else a.response.data.message&&(e=a.response.data.message);else a.message&&(e=a.message);y(e)}finally{z(!1),f(s)}},className:"space-y-8",children:[s.jsxs("div",{className:"bg-bg-light p-6 rounded-lg shadow-md",children:[s.jsx("h2",{className:"text-xl font-semibold text-white mb-4",children:"Exam Details"}),s.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[s.jsxs("div",{className:"md:col-span-2",children:[s.jsx("label",{htmlFor:"title",className:"block text-gray-300 mb-1",children:"Exam Title"}),s.jsx("input",{type:"text",id:"title",value:j,onChange:e=>v(e.target.value),className:`w-full bg-bg-dark border ${B.title?"border-red-500":"border-gray-700"} rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent`,placeholder:"Enter exam title"}),B.title&&s.jsx("div",{className:"text-red-500 text-sm mt-1",children:B.title})]}),s.jsxs("div",{className:"md:col-span-2",children:[s.jsx("label",{htmlFor:"description",className:"block text-gray-300 mb-1",children:"Description (min. 10 characters)"}),s.jsx("textarea",{id:"description",value:_,onChange:e=>$(e.target.value),className:`w-full bg-bg-dark border ${B.description?"border-red-500":"border-gray-700"} rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent min-h-[100px]`,placeholder:"Enter exam description (minimum 10 characters)"}),B.description&&s.jsx("div",{className:"text-red-500 text-sm mt-1",children:B.description})]}),s.jsxs("div",{children:[s.jsx("label",{htmlFor:"duration",className:"block text-gray-300 mb-1",children:"Duration (minutes)"}),s.jsx("input",{type:"number",id:"duration",value:N,onChange:e=>w(parseInt(e.target.value)||0),min:"1",className:`w-full bg-bg-dark border ${B.duration?"border-red-500":"border-gray-700"} rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent`}),B.duration&&s.jsx("div",{className:"text-red-500 text-sm mt-1",children:B.duration})]}),s.jsxs("div",{children:[s.jsx("label",{htmlFor:"section",className:"block text-gray-300 mb-1",children:"Section (Optional)"}),s.jsxs("select",{id:"section",value:S||"",onChange:e=>O(e.target.value?parseInt(e.target.value):null),className:`w-full bg-bg-dark border ${B.sectionId?"border-red-500":"border-gray-700"} rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent`,children:[s.jsx("option",{value:"",children:"-- No Section --"}),P.map((e=>s.jsx("option",{value:e.id,children:e.name},e.id)))]}),B.sectionId&&s.jsx("div",{className:"text-red-500 text-sm mt-1",children:B.sectionId})]}),s.jsxs("div",{children:[s.jsx("label",{htmlFor:"difficulty",className:"block text-gray-300 mb-1",children:"Difficulty"}),s.jsxs("select",{id:"difficulty",value:F,onChange:e=>T(e.target.value),className:`w-full bg-bg-dark border ${B.difficulty?"border-red-500":"border-gray-700"} rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent`,children:[s.jsx("option",{value:"easy",children:"Easy"}),s.jsx("option",{value:"medium",children:"Medium"}),s.jsx("option",{value:"hard",children:"Hard"})]}),B.difficulty&&s.jsx("div",{className:"text-red-500 text-sm mt-1",children:B.difficulty})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-gray-300 mb-3",children:"Accessibility"}),s.jsxs("div",{className:"flex items-center gap-4",children:[s.jsxs("label",{className:"inline-flex items-center",children:[s.jsx("input",{type:"radio",checked:C,onChange:()=>E(!0),className:"form-radio h-5 w-5 text-accent"}),s.jsx("span",{className:"ml-2 text-white",children:"Public (All ages)"})]}),s.jsxs("label",{className:"inline-flex items-center",children:[s.jsx("input",{type:"radio",checked:!C,onChange:()=>E(!1),className:"form-radio h-5 w-5 text-accent"}),s.jsx("span",{className:"ml-2 text-white",children:"Age Restricted"})]})]})]}),!C&&s.jsxs(s.Fragment,{children:[s.jsxs("div",{children:[s.jsx("label",{htmlFor:"minAge",className:"block text-gray-300 mb-1",children:"Min Age"}),s.jsx("input",{type:"number",id:"minAge",value:I,onChange:e=>q(parseInt(e.target.value)||0),min:"0",className:`w-full bg-bg-dark border ${B.minAge?"border-red-500":"border-gray-700"} rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent`}),B.minAge&&s.jsx("div",{className:"text-red-500 text-sm mt-1",children:B.minAge})]}),s.jsxs("div",{children:[s.jsx("label",{htmlFor:"maxAge",className:"block text-gray-300 mb-1",children:"Max Age"}),s.jsx("input",{type:"number",id:"maxAge",value:A,onChange:e=>k(parseInt(e.target.value)||0),min:"1",className:`w-full bg-bg-dark border ${B.maxAge?"border-red-500":"border-gray-700"} rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent`}),B.maxAge&&s.jsx("div",{className:"text-red-500 text-sm mt-1",children:B.maxAge})]})]})]})]}),s.jsx("h2",{className:"text-xl font-semibold text-white mb-4 border-t border-gray-700 pt-4",children:"الأسئلة"}),B.questions_summary&&s.jsx(a,{message:B.questions_summary,variant:"error",dismissible:!1}),D.map(((e,t)=>{const r=`question_${t}`;return s.jsxs("div",{className:"bg-bg-dark p-4 rounded-lg mb-4 border border-gray-700",children:[s.jsxs("div",{className:"flex justify-between items-center mb-3",children:[s.jsxs("h3",{className:"text-lg font-medium text-gray-200",children:["السؤال ",t+1]}),D.length>1&&s.jsx(n,{type:"button",variant:"danger",size:"sm",icon:s.jsx(o,{}),onClick:()=>{return t=e.id,void(D.length<=1?y("You must have at least one question"):L(D.filter((e=>e.id!==t))));var t},children:"إزالة"})]}),s.jsxs("div",{className:"mb-3",children:[s.jsxs("label",{htmlFor:`question-${e.id}`,className:"block text-gray-300 mb-1",children:["Question Title ",s.jsx("span",{className:"text-xs text-gray-400",children:"(at least 3 characters)"})]}),s.jsx("input",{type:"text",id:`question-${e.id}`,value:e.title,onChange:t=>{return r=e.id,i=t.target.value,void L(D.map((e=>e.id===r?{...e,title:i}:e)));var r,i},className:`w-full bg-bg-dark border ${B[`question_${t}_title`]?"border-red-500":"border-gray-600"} rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent`,placeholder:"Enter question title (minimum 3 characters)",minLength:3}),B[`question_${t}_title`]&&s.jsx("p",{className:"mt-1 text-red-500 text-sm",children:B[`question_${t}_title`]})]}),s.jsxs("div",{className:"mb-3",children:[s.jsx("label",{htmlFor:`${r}_type`,className:"block text-gray-400 mb-1 text-sm",children:"نوع السؤال"}),s.jsxs("select",{id:`${r}_type`,value:e.type,onChange:t=>{return r=e.id,i=t.target.value,void L(D.map((e=>{if(e.id!==r)return e;let t=e.options,s=e.correctOptionId,a=e.correctAnswerText,n=e.matchingItems,o=e.orderingItems;return"true-false"===i?(t=[{id:`${e.id}_opt_true`,text:"True"},{id:`${e.id}_opt_false`,text:"False"}],t.some((e=>e.id===s))||(s=null),a=""):"short-answer"===i?(t=[],s=null):"matching"===i?(t=[],s=null,(!n||n.length<2)&&(n=[{id:`match_${e.id}_1`,left:"",right:""},{id:`match_${e.id}_2`,left:"",right:""}])):"ordering"===i?(t=[],s=null,(!o||o.length<2)&&(o=[{id:`order_${e.id}_1`,text:"",correctPosition:1},{id:`order_${e.id}_2`,text:"",correctPosition:2},{id:`order_${e.id}_3`,text:"",correctPosition:3}])):(t.length<2&&(t=[{id:`${e.id}_opt_1`,text:""},{id:`${e.id}_opt_2`,text:""}]),a=""),{...e,type:i,options:t,correctOptionId:s,correctAnswerText:a,matchingItems:n,orderingItems:o}})));var r,i},className:"w-full bg-bg-dark border border-gray-600 rounded px-2 py-1 text-white focus:outline-none focus:border-primary",children:[s.jsx("option",{value:"multiple-choice",children:"اختيار من متعدد"}),s.jsx("option",{value:"true-false",children:"صح / خطأ"}),s.jsx("option",{value:"short-answer",children:"إجابة قصيرة"})]})]}),("multiple-choice"===e.type||"true-false"===e.type)&&s.jsxs("div",{className:"mb-3",children:[s.jsx("label",{className:"block text-gray-400 mb-1 text-sm",children:"الخيارات (حدد الإجابة الصحيحة)"}),e.options.map(((t,i)=>s.jsxs("div",{className:"flex items-center mb-2",children:[s.jsx("input",{type:"radio",name:`${r}_correct`,checked:e.correctOptionId===t.id,onChange:()=>{return r=e.id,i=t.id,void L(D.map((e=>e.id===r?{...e,correctOptionId:i}:e)));var r,i},className:"ml-2 form-radio h-4 w-4 text-primary focus:ring-primary border-gray-600 bg-bg-dark"}),s.jsx("input",{type:"text",value:t.text,onChange:r=>{return i=e.id,s=t.id,a=r.target.value,void L(D.map((e=>e.id===i?{...e,options:e.options.map((e=>e.id===s?{...e,text:a}:e))}:e)));var i,s,a},className:"flex-grow bg-bg-dark border rounded px-2 py-1 text-white text-sm focus:outline-none focus:border-primary mr-2 "+("true-false"===e.type?"border-gray-700 cursor-not-allowed":"border-gray-600"),placeholder:`خيار ${i+1}`,readOnly:"true-false"===e.type}),"multiple-choice"===e.type&&e.options.length>2&&s.jsx(n,{type:"button",variant:"danger",size:"sm",icon:s.jsx(l,{}),onClick:()=>((e,t)=>{const r=D.find((t=>t.id===e));if(!r||"multiple-choice"!==r.type)return;if(r.options.length<=2)return void y("Minimum 2 options per question");const i=r.correctOptionId===t?null:r.correctOptionId;L(D.map((r=>r.id===e?{...r,options:r.options.filter((e=>e.id!==t)),correctOptionId:i}:r)))})(e.id,t.id)}),B[`${r}_option_${i}`]&&s.jsx("p",{className:"ml-2 text-red-500 text-xs",children:"!"})]},t.id))),e.options.some(((e,t)=>B[`${r}_option_${t}`]))&&s.jsx("p",{className:"mt-1 text-red-500 text-sm",children:"جميع نصوص الخيارات مطلوبة."}),B[`${r}_correct`]&&s.jsx("p",{className:"mt-1 text-red-500 text-sm",children:B[`${r}_correct`]}),B[`${r}_options`]&&s.jsx("p",{className:"mt-1 text-red-500 text-sm",children:B[`${r}_options`]})]}),"short-answer"===e.type&&s.jsxs("div",{className:"mb-3",children:[s.jsx("label",{htmlFor:`${r}_correct_text`,className:"block text-gray-300 mb-1",children:"Correct Answer Text"}),s.jsx("input",{type:"text",id:`${r}_correct_text`,value:e.correctAnswerText||"",onChange:t=>{return r=e.id,i=t.target.value,void L(D.map((e=>e.id===r?{...e,correctAnswerText:i}:e)));var r,i},className:`w-full bg-bg-dark border ${B[`${r}_correct_text`]?"border-red-500":"border-gray-600"} rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent`,placeholder:"Enter correct answer text"}),B[`${r}_correct_text`]&&s.jsx("p",{className:"mt-1 text-red-500 text-sm",children:B[`${r}_correct_text`]})]}),("matching"===e.type||"ordering"===e.type)&&s.jsxs("div",{className:"mb-3",children:[s.jsx("label",{className:"block text-gray-300 mb-1",children:"Matching Items"}),e.matchingItems&&e.matchingItems.map(((r,i)=>s.jsxs("div",{className:"flex items-center mb-2",children:[s.jsx("label",{className:"block text-gray-300 mr-2",children:"Left:"}),s.jsx("input",{type:"text",value:r.left,onChange:t=>W(e.id,r.id,"left",t.target.value),className:`w-full bg-bg-dark border ${B[`question_${t}_matching_${i}_left`]?"border-red-500":"border-gray-600"} rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent`,placeholder:"Enter left side text"}),B[`question_${t}_matching_${i}_left`]&&s.jsx("p",{className:"mt-1 text-red-500 text-sm",children:B[`question_${t}_matching_${i}_left`]})]},r.id))),e.matchingItems&&e.matchingItems.map(((r,i)=>s.jsxs("div",{className:"flex items-center mb-2",children:[s.jsx("label",{className:"block text-gray-300 mr-2",children:"Right:"}),s.jsx("input",{type:"text",value:r.right,onChange:t=>W(e.id,r.id,"right",t.target.value),className:`w-full bg-bg-dark border ${B[`question_${t}_matching_${i}_right`]?"border-red-500":"border-gray-600"} rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent`,placeholder:"Enter right side text"}),B[`question_${t}_matching_${i}_right`]&&s.jsx("p",{className:"mt-1 text-red-500 text-sm",children:B[`question_${t}_matching_${i}_right`]})]},r.id)))]}),"ordering"===e.type&&s.jsxs("div",{className:"mb-3",children:[s.jsx("label",{className:"block text-gray-300 mb-1",children:"Ordering Items"}),e.orderingItems&&e.orderingItems.map(((r,i)=>s.jsxs("div",{className:"flex items-center mb-2",children:[s.jsx("label",{className:"block text-gray-300 mr-2",children:"Item:"}),s.jsx("input",{type:"text",value:r.text,onChange:t=>{return i=e.id,s=r.id,a=t.target.value,void L(D.map((e=>{var t;return e.id===i?{...e,orderingItems:(null==(t=e.orderingItems)?void 0:t.map((e=>e.id===s?{...e,text:a}:e)))||[]}:e})));var i,s,a},className:`w-full bg-bg-dark border ${B[`question_${t}_ordering_${i}`]?"border-red-500":"border-gray-600"} rounded-lg px-4 py-3 text-white focus:outline-none focus:border-accent`,placeholder:"Enter item text"}),B[`question_${t}_ordering_${i}`]&&s.jsx("p",{className:"mt-1 text-red-500 text-sm",children:B[`question_${t}_ordering_${i}`]})]},r.id)))]})]},e.id)})),s.jsx(n,{type:"button",variant:"secondary",icon:s.jsx(d,{}),onClick:()=>{L([...D,Y()])},className:"mt-4 mb-6",children:"إضافة سؤال"}),s.jsxs("div",{className:"flex justify-end gap-4 mt-8 border-t border-gray-700 pt-6",children:[s.jsx(n,{type:"button",variant:"secondary",onClick:()=>p("/admin/exams"),children:"Cancel"}),s.jsx(n,{type:"submit",variant:"primary",disabled:R,children:R?s.jsx(c,{}):"Create Exam"})]})]})]})};export{p as default};
